services:
  tms-trainer:
    image: domesticatedviking/textymcspeechy:piper-latest
    container_name: tms-${PROJECT_NAME}-trainer
    restart: unless-stopped
    
    # GPU passthrough configuration using CDI
    devices:
      - "nvidia.com/gpu=all"
    
    environment:
      - TMS_DATASETS=/workspace/datasets
      - TMS_CHECKPOINTS=/workspace/checkpoints
      - TMS_LOGS=/workspace/logs
      - TMS_AUDIO_SAMPLES=/workspace/audio_samples
      - CUDA_VISIBLE_DEVICES=0
      # CDI GPU passthrough environment variables
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - ../tms_workspace:/workspace
    ports:
      - "6006:6006"   # TensorBoard
      - "8765:8765"   # TMS web UI (if present)
    command: >
      sh -c "
        echo 'Waiting for dataset to be ready...' &&
        while [ ! -f /workspace/datasets/${PROJECT_NAME}/combined/metadata.csv ]; do
          sleep 5
        done &&
        echo 'Starting training...' &&
        python3 tts_dojo/train_piper.py
          --dataset ${PROJECT_NAME}/combined
          --base-checkpoint /workspace/checkpoints/base_checkpoints/${BASE_CHECKPOINT}
          --batch-size ${BATCH_SIZE}
          --max-epochs ${MAX_EPOCHS}
          --quality ${QUALITY}
          --accelerator ${ACCELERATOR}
          --devices ${DEVICES}
      "

